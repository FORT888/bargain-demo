<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„ Â· åŠ©åŠ›æŠ½å¥–</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ================= åŸºç¡€ ================= */
body{
  margin:0;
  min-height:100vh;
  background:#f8f8f8;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Helvetica Neue",Arial;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:420px;
  padding:28px 20px 48px;
}

/* ================= å“ç‰Œ ================= */
.brand-center{
  text-align:center;
  margin-bottom:26px;
}
.brand-title{
  font-size:30px;
  font-weight:800;
  color:#111;
  letter-spacing:2px;
}
.brand-subtitle{
  font-size:14px;
  color:#999;
  letter-spacing:4px;
  margin-top:4px;
}

/* ================= å¡ç‰‡ ================= */
.card{
  background:#fff;
  border-radius:24px;
  padding:34px 24px 32px;
  box-shadow:0 24px 64px rgba(0,0,0,.08);
}

/* ================= ä¸»è§†è§‰ ================= */
.hero{
  position:relative;
  display:flex;
  justify-content:center;
  margin:24px 0 18px;
}

/* æŠ½å¥–ä¸­çŠ¶æ€ */
.hero.waiting{
  height:220px;
  align-items:center;
}
.mystery{
  font-size:18px;
  color:#aaa;
  letter-spacing:4px;
  animation:blink 1.2s ease-in-out infinite;
}
@keyframes blink{
  0%,100%{opacity:.4}
  50%{opacity:1}
}

/* iPhone é‡‘å…‰ */
.hero.glow::before{
  content:"";
  position:absolute;
  width:240px;
  height:240px;
  border-radius:50%;
  background:
    radial-gradient(circle,
      rgba(255,209,102,.55) 0%,
      rgba(255,183,3,.35) 40%,
      rgba(255,183,3,.15) 60%,
      rgba(255,183,3,0) 75%);
  filter:blur(6px);
  animation:glowPulse 2.8s ease-in-out infinite;
}
@keyframes glowPulse{
  0%{transform:scale(.95);opacity:.7}
  50%{transform:scale(1.05);opacity:1}
  100%{transform:scale(.95);opacity:.7}
}

.hero-img{
  width:210px;
  z-index:1;
  filter:drop-shadow(0 24px 48px rgba(0,0,0,.25));
  animation:floatIn .6s ease;
}
@keyframes floatIn{
  from{opacity:0;transform:translateY(20px) scale(.9)}
  to{opacity:1;transform:none}
}

/* ================= æ–‡æ¡ˆ ================= */
.hero-text{
  text-align:center;
  margin-bottom:26px;
}
.hero-sub{
  font-size:14px;
  color:#999;
  margin-bottom:6px;
}
.hero-title{
  font-size:22px;
  font-weight:700;
  color:#111;
}

/* ================= è¿›åº¦ ================= */
.progress-wrap{margin:22px 0 16px;}
.progress-bar{
  height:8px;
  background:#eee;
  border-radius:999px;
  overflow:hidden;
}
.progress-inner{
  height:100%;
  width:0%;
  background:#E60023;
}
.progress-text{
  font-size:12px;
  color:#999;
  text-align:center;
  margin-top:8px;
}

/* ================= æŒ‰é’® ================= */
.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-size:16px;
  margin-top:12px;
}
.primary{
  background:#E60023;
  color:#fff;
  font-weight:600;
}
.primary:active{background:#C8001E}
.secondary{
  background:#fff5f7;
  color:#E60023;
}
.btn:disabled{opacity:.5}

/* ================= é“¾æ¥ ================= */
.link{
  margin-top:16px;
  font-size:12px;
  color:#999;
  word-break:break-all;
  text-align:center;
}
</style>
</head>

<body>

<div class="container">

  <!-- å“ç‰Œ -->
  <div class="brand-center">
    <div class="brand-title">è”ä¿¡èµ„</div>
    <div class="brand-subtitle">åŠ©åŠ›æŠ½å¥–</div>
  </div>

  <div class="card">

    <!-- ä¸»è§†è§‰ -->
    <div class="hero waiting" id="hero">
      <div class="mystery" id="mysteryText">æŠ½å¥–ä¸­â€¦</div>
      <img id="prizeImg" class="hero-img" style="display:none">
    </div>

    <!-- æ–‡æ¡ˆ -->
    <div class="hero-text">
      <div class="hero-sub" id="heroSub">è¯·ç‚¹å‡»å¼€å§‹æŠ½å¥–</div>
      <div class="hero-title" id="resultText">â€”</div>
    </div>

    <!-- è¿›åº¦ -->
    <div class="progress-wrap">
      <div class="progress-bar">
        <div class="progress-inner" id="progressInner"></div>
      </div>
      <div class="progress-text" id="progressText">å®Œæˆè¿›åº¦ 0%</div>
    </div>

    <!-- æŒ‰é’® -->
    <button id="btnHelp" class="btn secondary">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
    <button id="btnCreate" class="btn primary">å‘èµ·åŠ©åŠ›</button>

    <div class="link" id="shareLink"></div>
  </div>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
  projectId: "cut-demo-e11b9"
});
const db = firebase.firestore();

const CREATE_API = "https://createactivity-23p22ouguq-uc.a.run.app";
const HELP_API   = "https://helpactivity-23p22ouguq-uc.a.run.app";

/* ================= å¥–å“ ================= */
const PRIZES = [
  {key:"66",label:"66 å…ƒ"},
  {key:"88",label:"88 å…ƒ"},
  {key:"388",label:"388 å…ƒ"},
  {key:"588",label:"588 å…ƒ"},
  {key:"888",label:"888 å…ƒ"},
  {key:"1888",label:"1888 å…ƒ"},
  {key:"iphone",label:"iPhone 17 Pro Max"}
];

/* ================= è®¾å¤‡ ID ================= */
function genUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
let deviceId = localStorage.deviceId || (localStorage.deviceId=genUUID());

/* ================= DOM ================= */
const hero = document.getElementById("hero");
const prizeImg = document.getElementById("prizeImg");
const mysteryText = document.getElementById("mysteryText");
const heroSub = document.getElementById("heroSub");
const resultText = document.getElementById("resultText");
const progressInner = document.getElementById("progressInner");
const progressText = document.getElementById("progressText");
const btnCreate = document.getElementById("btnCreate");
const btnHelp = document.getElementById("btnHelp");

/* ================= æŠ½å¥–è¿‡ç¨‹ + æ­æ™“ ================= */
function startDraw(prizeKey){
  // æŠ½å¥–ä¸­
  hero.className = "hero waiting";
  mysteryText.style.display = "block";
  prizeImg.style.display = "none";
  heroSub.innerText = "æ­£åœ¨æŠ½å–å¥–å“â€¦";
  resultText.innerText = "â€”";

  setTimeout(()=>{
    renderPrize(prizeKey);
  }, 1400); // â­ æŠ½å¥–æ„Ÿå…³é”®
}

function renderPrize(prizeKey){
  hero.className = "hero";
  mysteryText.style.display = "none";
  prizeImg.style.display = "block";

  if(prizeKey === "iphone"){
    prizeImg.src = "/iphone.png";
    hero.classList.add("glow");
    resultText.innerText = "iPhone 17 Pro Max";
  }else{
    prizeImg.src = "/hongbao.png";
    resultText.innerText =
      PRIZES.find(p=>p.key===prizeKey)?.label || "";
  }

  heroSub.innerText = "æ­å–œè·å¾—";
}

/* ================= ç›‘å¬è¿›åº¦ ================= */
function watch(activityId){
  db.collection("activities").doc(activityId).onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data();
    progressInner.style.width = (d.progress||0) + "%";
    progressText.innerText =
      "å®Œæˆè¿›åº¦ " + (d.progress||0).toFixed(1) + "%";
  });
}

/* ================= é¡µé¢åŠ è½½ ================= */
window.onload = async ()=>{
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{"x-device-id":deviceId}
  });
  const d = await r.json();
  if(d.success && d.reused){
    startDraw(d.prizeKey);
    btnCreate.disabled=true;
    btnCreate.innerText="å·²å‘èµ·åŠ©åŠ›";
    watch(d.activityId);
    document.getElementById("shareLink").innerText =
      location.origin + location.pathname + "?from=" + d.activityId;
  }
};

/* ================= å‘èµ·åŠ©åŠ› ================= */
btnCreate.onclick = async ()=>{
  btnCreate.disabled=true;
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{"x-device-id":deviceId}
  });
  const d = await r.json();
  if(!d.success) return;
  startDraw(d.prizeKey);
  watch(d.activityId);
  document.getElementById("shareLink").innerText =
    location.origin + location.pathname + "?from=" + d.activityId;
};

/* ================= åŠ©åŠ› ================= */
const params = new URLSearchParams(location.search);
const fromActivityId = params.get("from");

if(!fromActivityId){
  btnHelp.disabled=true;
  btnHelp.innerText="è¯·åˆ†äº«é“¾æ¥ç»™å¥½å‹åŠ©åŠ›";
}else{
  watch(fromActivityId);
}

btnHelp.onclick = async ()=>{
  const r = await fetch(HELP_API,{
    method:"POST",
    headers:{"x-device-id":deviceId},
    body:JSON.stringify({activityId:fromActivityId})
  });
  const d = await r.json();
  if(!d.success){
    alert(d.error||"ä½ å·²ç»åŠ©è¿‡åŠ›äº†");
    btnHelp.disabled=true;
    btnHelp.innerText="å·²åŠ©åŠ›";
    return;
  }
  btnHelp.disabled=true;
  btnHelp.innerText="å·²æˆåŠŸåŠ©åŠ› ğŸ‰";
};
</script>

</body>
</html>



















