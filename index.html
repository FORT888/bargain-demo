<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„åŠ©åŠ›æŠ½å¥–</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(180deg,#f7f8fa 0%,#eef1f5 100%);
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC";
  display:flex;
  justify-content:center;
}
.container{
  width:100%;
  max-width:420px;
  padding:22px 18px 44px;
}

/* å¤´éƒ¨ */
.brand{text-align:center;margin-bottom:14px;}
.brand-logo{width:92px;margin:0 auto 10px;}
.brand-logo img{width:100%;display:block;}
.brand-title{font-size:34px;font-weight:900;}
.brand-subtitle{font-size:14px;margin-top:4px;color:#777;letter-spacing:6px;}

.card{
  background:rgba(255,255,255,.94);
  border-radius:26px;
  padding:28px 22px 36px;
  margin-top:18px;
  box-shadow:0 28px 60px rgba(0,0,0,.12);
}

/* æŠ½å¥–åœ† */
.hero{display:flex;justify-content:center;margin:26px 0 22px;}
.circle{
  width:260px;height:260px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #ffffff, #ededed);
  box-shadow:0 22px 48px rgba(0,0,0,.18);
  position:relative;overflow:hidden;
}

/* è¿›åº¦ */
.progress-title{
  position:absolute;bottom:54px;left:50%;
  transform:translateX(-50%);
  font-size:12px;font-weight:600;color:#666;
}
.progress-wrap{
  position:absolute;bottom:34px;left:50%;
  transform:translateX(-50%);
  width:200px;height:6px;
  background:#e6e6e6;border-radius:999px;
}
.progress-inner{height:100%;width:0%;background:#e60023;border-radius:999px;}
.progress-text{
  position:absolute;bottom:20px;left:50%;
  transform:translateX(-50%);
  font-size:12px;font-weight:600;color:#e60023;
}

/* å¥–å“ */
.prize-item{
  position:absolute;
  top:-110px;
  left:50%;
  transform:translateX(-50%);
  width:130px;
  opacity:0;
  animation:drop 3s ease-in-out forwards;
}
.prize-final{
  position:absolute;
  top:38%;
  left:50%;
  transform:translate(-50%,-50%);
  width:165px;
}

@keyframes drop{
  0%{transform:translate(-50%,-110px) scale(.92);opacity:0}
  35%{opacity:1}
  100%{transform:translate(-50%,135px) scale(1);opacity:0}
}

/* æ­å–œ */
.congrats{
  margin-top:10px;
  font-size:15px;
  font-weight:700;
  color:#e60023;
  text-align:center;
  display:none;
}

/* æŒ‰é’® */
button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  font-size:16px;
  margin-top:16px;
}
.primary{background:#e60023;color:#fff;font-weight:700;}
.secondary{background:#fff1f3;color:#e60023;font-weight:600;}
button:disabled{opacity:.5}

.link{
  margin-top:16px;
  font-size:12px;
  color:#999;
  text-align:center;
  word-break:break-all;
}
</style>
</head>

<body>
<div class="container">

  <div class="brand">
    <div class="brand-logo"><img src="/logo.png"></div>
    <div class="brand-title">è”ä¿¡èµ„</div>
    <div class="brand-subtitle">åŠ©åŠ›æŠ½å¥–</div>
  </div>

  <div class="card">
    <div class="hero">
      <div class="circle" id="circle">
        <div class="progress-title">å®Œæˆè¿›åº¦</div>
        <div class="progress-wrap"><div class="progress-inner" id="progressInner"></div></div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
    </div>

    <div class="congrats" id="congrats"></div>

    <button id="btnHelp" class="secondary">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
    <button id="btnCreate" class="primary">å‘èµ·åŠ©åŠ›è¯•è¯•</button>

    <div class="link" id="shareLink"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
  projectId:"cut-demo-e11b9"
});
const db=firebase.firestore();

const CREATE_API="https://createactivity-23p22ouguq-uc.a.run.app";
const HELP_API="https://helpactivity-23p22ouguq-uc.a.run.app";

const PRIZE_IMG={
  "1888":"/1888.png","588":"/588.png","888":"/888.png",
  "66":"/hongbao.png","88":"/hongbao.png","388":"/hongbao.png",
  "iphone":"/iphone.png","shouji":"/shouji.png",
  "rice":"/dami.png","oil":"/you.png"
};
const CAROUSEL=["1888","588","888","66","88","388","rice","oil","shouji","iphone"];

function genUUID(){
  return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
let deviceId=localStorage.deviceId||(localStorage.deviceId=genUUID());

const circle=document.getElementById("circle");
const btnCreate=document.getElementById("btnCreate");
const btnHelp=document.getElementById("btnHelp");
const progressInner=document.getElementById("progressInner");
const progressText=document.getElementById("progressText");
const shareLink=document.getElementById("shareLink");
const congrats=document.getElementById("congrats");

let timer=null;

/* â­ é¡µé¢ä¸€åŠ è½½å°±è½®æ’­ */
function startCarousel(){
  let index=0;
  timer=setInterval(()=>{
    const img=document.createElement("img");
    img.src=PRIZE_IMG[CAROUSEL[index]];
    img.className="prize-item";
    circle.appendChild(img);
    setTimeout(()=>img.remove(),3000);
    index=(index+1)%CAROUSEL.length;
  },1100);
}
startCarousel();

/* åˆ›å»ºååœè½®æ’­ */
function stopAndFinal(prizeKey){
  clearInterval(timer);
  circle.querySelectorAll(".prize-item").forEach(el=>el.remove());
  const img=document.createElement("img");
  img.src=PRIZE_IMG[prizeKey];
  img.className="prize-final";
  circle.appendChild(img);
}

/* è‡ªå·±å‘èµ· */
btnCreate.onclick=async()=>{
  btnCreate.disabled=true;
  const r=await fetch(CREATE_API,{
    method:"POST",
    headers:{"x-device-id":deviceId}
  });
  const d=await r.json();
  if(!d.success)return;

  stopAndFinal(d.prizeKey);
  congrats.innerText="ğŸ‰ æ­å–œè·å¾— "+d.prizeKey+" å¥–åŠ±";
  congrats.style.display="block";
  shareLink.innerText=location.origin+location.pathname+"?from="+d.activityId;
  watch(d.activityId);
};

/* ç›‘å¬è¿›åº¦ */
function watch(id){
  db.collection("activities").doc(id).onSnapshot(snap=>{
    if(!snap.exists)return;
    const p=snap.data().progress||0;
    progressInner.style.width=p+"%";
    progressText.innerText=p.toFixed(1)+"%";
  });
}

/* å¸®åŠ©å¥½å‹ */
const params=new URLSearchParams(location.search);
const fromId=params.get("from");
if(fromId){
  btnCreate.disabled=true;
  watch(fromId);
}

btnHelp.onclick=async()=>{
  if(!fromId)return;
  const r=await fetch(HELP_API,{
    method:"POST",
    headers:{"x-device-id":deviceId},
    body:JSON.stringify({activityId:fromId})
  });
  const d=await r.json();
  if(!d.success)return;
  btnHelp.disabled=true;
  btnHelp.innerText="å·²æˆåŠŸåŠ©åŠ› ğŸ‰";
};
</script>

</body>
</html>






