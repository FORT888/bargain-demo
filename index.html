<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„ Â· åŠ©åŠ›æŠ½å¥–</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:#f7f7f7;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC";
  display:flex;
  justify-content:center;
}
.container{
  width:100%;
  max-width:420px;
  padding:24px 16px 40px;
}

/* å“ç‰Œ */
.brand{
  text-align:center;
  margin-bottom:18px;
}
.brand h1{
  margin:0;
  font-size:30px;
  font-weight:800;
  letter-spacing:2px;
}
.brand p{
  margin-top:6px;
  font-size:14px;
  color:#999;
  letter-spacing:4px;
}

/* å¡ç‰‡ */
.card{
  background:#fff;
  border-radius:22px;
  padding:28px 20px 26px;
  box-shadow:0 20px 50px rgba(0,0,0,.1);
}

/* æ‰­è›‹æœº */
.hero{
  display:flex;
  justify-content:center;
  margin:20px 0 12px;
}
.gacha{
  width:200px;
  height:200px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff, #eaeaea);
  box-shadow:0 16px 36px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
}
.gacha::after{
  content:"";
  width:110px;
  height:110px;
  border-radius:50%;
  background:linear-gradient(#e60023,#c8001e);
}
.gacha.spin{
  animation:shake .8s ease;
}
@keyframes shake{
  0%{transform:rotate(0)}
  25%{transform:rotate(-6deg)}
  50%{transform:rotate(6deg)}
  75%{transform:rotate(-4deg)}
  100%{transform:rotate(0)}
}

/* ç»“æœ */
.result{
  text-align:center;
  font-size:18px;
  font-weight:700;
  margin:10px 0 14px;
}

/* è¿›åº¦ */
.progress-bar{
  height:8px;
  background:#eee;
  border-radius:999px;
  overflow:hidden;
}
.progress-inner{
  height:100%;
  width:0%;
  background:#e60023;
}
.progress-text{
  font-size:12px;
  color:#999;
  text-align:center;
  margin-top:6px;
}

/* æŒ‰é’® */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  margin-top:12px;
}
.primary{
  background:#e60023;
  color:#fff;
  font-weight:600;
}
.secondary{
  background:#fff5f7;
  color:#e60023;
}
button:disabled{opacity:.5}

.link{
  margin-top:12px;
  font-size:12px;
  color:#999;
  word-break:break-all;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">

  <div class="brand">
    <h1>è”ä¿¡èµ„</h1>
    <p>åŠ©åŠ›æŠ½å¥–</p>
  </div>

  <div class="card">

    <!-- æ‰­è›‹æœº -->
    <div class="hero">
      <div class="gacha" id="gacha"></div>
    </div>

    <div class="result" id="resultText">ç‚¹å‡»å¼€å§‹æŠ½å¥–</div>

    <!-- è¿›åº¦ -->
    <div class="progress-bar">
      <div class="progress-inner" id="progressInner"></div>
    </div>
    <div class="progress-text" id="progressText">å®Œæˆè¿›åº¦ 0%</div>

    <!-- ä½ çš„ä¸¤ä¸ªæŒ‰é’®ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ -->
    <button id="btnHelp" class="secondary">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
    <button id="btnCreate" class="primary">å‘èµ·åŠ©åŠ›è¯•è¯•</button>

    <div class="link" id="shareLink"></div>
  </div>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey:"AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
  projectId:"cut-demo-e11b9"
});
const db = firebase.firestore();

const CREATE_API = "https://createactivity-23p22ouguq-uc.a.run.app";
const HELP_API   = "https://helpactivity-23p22ouguq-uc.a.run.app";

/* ================= å¥–å“æ˜ å°„ï¼ˆä¸¥æ ¼ï¼‰ ================= */
const PRIZE_MAP = {
  "66":"çº¢åŒ… 66 å…ƒ",
  "88":"çº¢åŒ… 88 å…ƒ",
  "388":"çº¢åŒ… 388 å…ƒ",
  "588":"çº¢åŒ… 588 å…ƒ",
  "888":"çº¢åŒ… 888 å…ƒ",
  "1888":"çº¢åŒ… 1888 å…ƒ",
  "iphone":"è‹¹æœ 17 Pro Max",
  "rice":"å¤§ç±³ä¸€è¢‹",
  "oil":"é£Ÿç”¨æ²¹ä¸€æ¡¶"
};

/* ================= deviceId ================= */
function genUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
let deviceId = localStorage.deviceId || (localStorage.deviceId=genUUID());

/* ================= DOM ================= */
const gacha = document.getElementById("gacha");
const resultText = document.getElementById("resultText");
const btnCreate = document.getElementById("btnCreate");
const btnHelp = document.getElementById("btnHelp");

/* ================= æ‰­è›‹æ¼”ç»ï¼ˆä¸éšæœºï¼‰ ================= */
function playGacha(prizeKey){
  const label = PRIZE_MAP[prizeKey] || "";
  gacha.classList.add("spin");
  resultText.innerText = "æŠ½å¥–ä¸­â€¦";

  setTimeout(()=>{
    gacha.classList.remove("spin");
    resultText.innerText = "ğŸ‰ æ­å–œè·å¾—ï¼š" + label;
  },800);
}

/* ================= ç›‘å¬è¿›åº¦ ================= */
function watch(activityId){
  db.collection("activities").doc(activityId).onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data();
    document.getElementById("progressInner").style.width = (d.progress||0)+"%";
    document.getElementById("progressText").innerText =
      "å®Œæˆè¿›åº¦ "+(d.progress||0).toFixed(1)+"%";
  });
}

/* ================= é¡µé¢åŠ è½½ï¼ˆå¤ç”¨æ´»åŠ¨ï¼‰ ================= */
window.onload = async ()=>{
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{ "x-device-id": deviceId }
  });
  const d = await r.json();

  if(d.success && d.reused){
    playGacha(d.prizeKey);
    btnCreate.disabled=true;
    btnCreate.innerText="å·²å‘èµ·åŠ©åŠ›";
    watch(d.activityId);
    document.getElementById("shareLink").innerText =
      location.origin+location.pathname+"?from="+d.activityId;
  }
};

/* ================= å‘èµ·åŠ©åŠ› ================= */
btnCreate.onclick = async ()=>{
  btnCreate.disabled=true;
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{ "x-device-id": deviceId }
  });
  const d = await r.json();
  if(!d.success) return;

  playGacha(d.prizeKey);
  watch(d.activityId);
  document.getElementById("shareLink").innerText =
    location.origin+location.pathname+"?from="+d.activityId;
};

/* ================= å¸®æœ‹å‹åŠ©åŠ› ================= */
const params = new URLSearchParams(location.search);
const fromActivityId = params.get("from");

if(!fromActivityId){
  btnHelp.disabled=true;
  btnHelp.innerText="è¯·åˆ†äº«é“¾æ¥ç»™å¥½å‹åŠ©åŠ›";
}else{
  watch(fromActivityId);
}

btnHelp.onclick = async ()=>{
  const r = await fetch(HELP_API,{
    method:"POST",
    headers:{ "x-device-id": deviceId },
    body:JSON.stringify({ activityId: fromActivityId })
  });
  const d = await r.json();
  if(!d.success){
    alert(d.error||"ä½ å·²ç»åŠ©è¿‡åŠ›äº†");
    btnHelp.disabled=true;
    return;
  }
  btnHelp.disabled=true;
  btnHelp.innerText="å·²æˆåŠŸåŠ©åŠ› ğŸ‰";
};
</script>

</body>
</html>
