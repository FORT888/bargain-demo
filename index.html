<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„åŠ©åŠ›æŠ½å¥–</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:#f5f5f7;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC";
  display:flex;
  justify-content:center;
}
.container{
  width:100%;
  max-width:420px;
  padding:22px 16px 40px;
}

/* logo */
.logo{
  display:block;
  margin:0 auto 8px;
  width:70px;
}

/* æ ‡é¢˜ */
.title{
  text-align:center;
  font-size:36px;
  font-weight:800;
  letter-spacing:2px;
}
.subtitle{
  text-align:center;
  font-size:18px;
  margin-top:6px;
  color:#666;
  letter-spacing:4px;
}

/* å¡ç‰‡ */
.card{
  background:#fff;
  border-radius:24px;
  padding:28px 20px 30px;
  margin-top:20px;
  box-shadow:0 25px 60px rgba(0,0,0,.12);
}

/* æŠ½å¥–åœ† */
.hero{
  display:flex;
  justify-content:center;
  margin:26px 0 20px;
}
.circle{
  width:240px;
  height:240px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #ffffff, #eaeaea);
  box-shadow:inset 0 0 30px rgba(0,0,0,.06),
             0 20px 45px rgba(0,0,0,.18);
  position:relative;
  overflow:hidden;
}

/* åœ†å†…è¿›åº¦æ¡ */
.circle-progress{
  position:absolute;
  bottom:22px;
  left:50%;
  transform:translateX(-50%);
  width:150px;
  height:6px;
  background:#ddd;
  border-radius:999px;
  overflow:hidden;
  z-index:3;
}
.circle-progress-inner{
  height:100%;
  width:0%;
  background:#e60023;
}

/* å¥–å“è½®æ’­å›¾ç‰‡ */
.prize-item{
  position:absolute;
  top:-60px;
  left:50%;
  transform:translateX(-50%);
  width:72px;
  opacity:0;
  animation:drop 1.8s ease-in-out forwards;
  z-index:2;
}

@keyframes drop{
  0%{
    transform:translate(-50%,-60px) scale(.9);
    opacity:0;
  }
  30%{
    opacity:1;
  }
  100%{
    transform:translate(-50%,90px) scale(1);
    opacity:0;
  }
}

/* æœ€ç»ˆåœç•™ */
.prize-final{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:92px;
  z-index:4;
}

/* æŒ‰é’® */
button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:16px;
  font-size:16px;
  margin-top:12px;
}
.primary{
  background:#e60023;
  color:#fff;
  font-weight:600;
}
.secondary{
  background:#fff3f6;
  color:#e60023;
}
button:disabled{opacity:.5}

.link{
  margin-top:14px;
  font-size:12px;
  color:#999;
  text-align:center;
  word-break:break-all;
}
</style>
</head>

<body>
<div class="container">

  <!-- logo -->
  <img src="/logo.png" class="logo">

  <!-- æ ‡é¢˜ -->
  <div class="title">è”ä¿¡èµ„</div>
  <div class="subtitle">åŠ©åŠ›æŠ½å¥–</div>

  <div class="card">

    <!-- æŠ½å¥–åœ† -->
    <div class="hero">
      <div class="circle" id="circle">
        <div class="circle-progress">
          <div class="circle-progress-inner" id="progressInner"></div>
        </div>
      </div>
    </div>

    <!-- æŒ‰é’®ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ -->
    <button id="btnHelp" class="secondary">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
    <button id="btnCreate" class="primary">å‘èµ·åŠ©åŠ›è¯•è¯•</button>

    <div class="link" id="shareLink"></div>
  </div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
  projectId:"cut-demo-e11b9"
});
const db = firebase.firestore();

const CREATE_API = "https://createactivity-23p22ouguq-uc.a.run.app";
const HELP_API   = "https://helpactivity-23p22ouguq-uc.a.run.app";

/* å¥–å“å›¾ç‰‡æ˜ å°„ï¼ˆçœŸå®æ–‡ä»¶ï¼‰ */
const PRIZE_IMG = {
  "1888":"/1888.png",
  "588":"/588.png",
  "888":"/888.png",
  "66":"/hongbao.png",
  "88":"/hongbao.png",
  "388":"/hongbao.png",
  "iphone":"/iphone.png",
  "rice":"/dami.png",
  "oil":"/you.png",
  "shouji":"/shouji.png"
};

/* è½®æ’­é¡ºåºï¼ˆå±•ç¤ºç”¨ï¼‰ */
const CAROUSEL = [
  "1888","588","888","66","88","388","rice","oil","iphone"
];

/* deviceId */
function genUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
let deviceId = localStorage.deviceId || (localStorage.deviceId=genUUID());

const circle = document.getElementById("circle");
const progressInner = document.getElementById("progressInner");
const btnCreate = document.getElementById("btnCreate");
const btnHelp = document.getElementById("btnHelp");
const shareLink = document.getElementById("shareLink");

let carouselTimer = null;

/* æ ¸å¿ƒï¼šè½®æ’­ â†’ åœåœ¨åç«¯ prizeKey */
function playCarousel(finalKey){
  let index = 0;
  let rounds = 0;
  const maxRounds = 3;     // è½¬å‡ åœˆ
  const interval = 650;   // è¶Šå¤§è¶Šæ…¢

  // æ¸…ç†æ—§çŠ¶æ€
  circle.querySelectorAll(".prize-item,.prize-final").forEach(el=>el.remove());
  clearInterval(carouselTimer);

  carouselTimer = setInterval(()=>{
    const img = document.createElement("img");
    img.src = PRIZE_IMG[CAROUSEL[index]] || "/hongbao.png";
    img.className = "prize-item";
    circle.appendChild(img);

    setTimeout(()=>img.remove(),1800);

    index++;
    if(index >= CAROUSEL.length){
      index = 0;
      rounds++;
    }

    if(rounds >= maxRounds){
      clearInterval(carouselTimer);

      setTimeout(()=>{
        const finalImg = document.createElement("img");
        finalImg.src = PRIZE_IMG[finalKey] || "/hongbao.png";
        finalImg.className = "prize-final";
        circle.appendChild(finalImg);
      },900);
    }
  }, interval);
}

/* ç›‘å¬è¿›åº¦ */
function watch(activityId){
  db.collection("activities").doc(activityId).onSnapshot(snap=>{
    if(!snap.exists) return;
    progressInner.style.width = (snap.data().progress||0) + "%";
  });
}

/* é¡µé¢åŠ è½½å¤ç”¨ */
window.onload = async ()=>{
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{ "x-device-id":deviceId }
  });
  const d = await r.json();
  if(d.success && d.reused){
    playCarousel(d.prizeKey);
    btnCreate.disabled = true;
    btnCreate.innerText = "å·²å‘èµ·åŠ©åŠ›";
    watch(d.activityId);
    shareLink.innerText =
      location.origin + location.pathname + "?from=" + d.activityId;
  }
};

/* å‘èµ·åŠ©åŠ› */
btnCreate.onclick = async ()=>{
  btnCreate.disabled = true;
  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{ "x-device-id":deviceId }
  });
  const d = await r.json();
  if(!d.success) return;

  playCarousel(d.prizeKey);
  watch(d.activityId);
  shareLink.innerText =
    location.origin + location.pathname + "?from=" + d.activityId;
};

/* å¸®åŠ©å¥½å‹åŠ©åŠ› */
const params = new URLSearchParams(location.search);
const fromActivityId = params.get("from");
if(!fromActivityId){
  btnHelp.disabled = true;
  btnHelp.innerText = "è¯·åˆ†äº«é“¾æ¥ç»™å¥½å‹åŠ©åŠ›";
}else{
  watch(fromActivityId);
}
btnHelp.onclick = async ()=>{
  const r = await fetch(HELP_API,{
    method:"POST",
    headers:{ "x-device-id":deviceId },
    body:JSON.stringify({ activityId: fromActivityId })
  });
  const d = await r.json();
  if(!d.success){
    alert(d.error || "å·²åŠ©åŠ›");
    btnHelp.disabled = true;
    return;
  }
  btnHelp.disabled = true;
  btnHelp.innerText = "å·²æˆåŠŸåŠ©åŠ› ğŸ‰";
};
</script>

</body>
</html>





