<script>
  /******** Firebase é…ç½® ********/
  const firebaseConfig = {
      apiKey: "AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
      authDomain: "cut-demo-e11b9.firebaseapp.com",
      projectId: "cut-demo-e11b9",
      storageBucket: "cut-demo-e11b9.firebasestorage.app",
      messagingSenderId: "1065166593402",
      appId: "1:1065166593402:web:3a260d266b39c14c9fcac3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /******** åç«¯æ¥å£ï¼ˆâš ï¸ å·²ä¿®æ­£ï¼‰ ********/
  const HELP_API = "https://helpactivity-23p22ouguq-uc.a.run.app";
  const GET_UID_API = "https://getuid-23p22ouguq-uc.a.run.app";

  let uid = null;
  let currentProgress = 0;
  let currentAngle = 0;

  /******** è·å– UIDï¼ˆIP = UIDï¼‰ ********/
  async function getUid() {
    let u = localStorage.getItem("uid");
    if (u) return u;

    const res = await fetch(GET_UID_API);
    const data = await res.json();
    localStorage.setItem("uid", data.uid);
    return data.uid;
  }

  getUid().then(u => uid = u);

  const params = new URLSearchParams(location.search);
  const activityId = params.get("from");

  /* ===== è½¬ç›˜åŠ¨ç”» ===== */
  function rotateToProgress(progress, firstLoad = false) {
    const angle = progress * 3.6; // 100% = 360Â°
    const extra = firstLoad ? 1080 : 720; // é¦–æ¬¡å¤šè½¬ä¸€åœˆ
    currentAngle = extra + angle;

    document.getElementById("wheel").style.transform =
      `rotate(${currentAngle}deg)`;

    document.getElementById("percentText").innerText =
      `å½“å‰è¿›åº¦ï¼š${progress.toFixed(2)}%`;
  }

  async function loadActivity(id, firstLoad = false) {
    const snap = await db.collection("activities").doc(id).get();
    if (!snap.exists) return;

    const p = snap.data().progress || 0;
    rotateToProgress(p, firstLoad);
    currentProgress = p;
  }

  /******** å‘èµ·åŠ©åŠ› ********/
  document.getElementById("btnCreate").onclick = async () => {
    if (!uid) return alert("åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å");

    const ref = await db.collection("activities").add({
      owner: uid,
      helperCount: 0,
      progress: 0,
      finished: false,
      createdAt: Date.now()
    });

    const link = location.origin + location.pathname + "?from=" + ref.id;
    document.getElementById("hintText").innerText =
      "åˆ†äº«é“¾æ¥ç»™å¥½å‹åŠ©åŠ›ï¼š" + link;

    loadActivity(ref.id, true);
  };

  /******** å¸®å¥½å‹åŠ©åŠ› ********/
  document.getElementById("btnHelp").onclick = async () => {
    if (!activityId) {
      alert("è¯·é€šè¿‡å¥½å‹åˆ†äº«é“¾æ¥è¿›å…¥");
      return;
    }
    if (!uid) return;

    const res = await fetch(HELP_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ activityId, uid })
    });

    const data = await res.json();
    if (data.success) {
      loadActivity(activityId);
    } else {
      alert(data.error || "ä½ å·²åŠ©è¿‡åŠ›äº†");
    }
  };

  // ğŸ”„ é¡µé¢é¦–æ¬¡æ‰“å¼€ï¼Œå¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œå…ˆè½¬ä¸€åœˆå†åœ
  if (activityId) {
    loadActivity(activityId, true);
  }
</script>
