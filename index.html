<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„ Â· åŠ©åŠ›è½¬ç›˜</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,#fff7ed,#fee2e2);
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
  display:flex;justify-content:center;align-items:center;
  overflow:hidden;
}
.card{
  width:92%;max-width:420px;background:#fff;border-radius:28px;
  padding:22px 18px 26px;box-shadow:0 30px 80px rgba(0,0,0,.15);
  text-align:center;position:relative;z-index:2;
}
h1{margin:6px 0;font-size:22px}
.prize-box{font-size:16px;font-weight:700;margin-bottom:10px}
.prize-box span{color:#dc2626}

.wheel-wrap{width:300px;height:300px;margin:16px auto;position:relative}
#wheel{width:100%;height:100%;border-radius:50%;
  transition:transform 3.8s cubic-bezier(.25,.9,.25,1)}
#centerLogo{
  position:absolute;left:50%;top:50%;
  width:120px;height:120px;transform:translate(-50%,-50%);
  pointer-events:none
}

.progress-bar{height:14px;background:#fde68a;border-radius:999px;overflow:hidden}
.progress-inner{
  height:100%;width:0%;
  background:linear-gradient(90deg,#ef4444,#f59e0b);
  transition:width .4s ease
}
.progress-text{margin-top:6px;font-size:13px;font-weight:600;color:#b91c1c}

.btn{
  width:100%;margin-top:10px;padding:14px;
  border:none;border-radius:16px;font-size:16px;font-weight:600
}
.primary{background:#ef4444;color:#fff}
.secondary{background:#fff1f2;color:#ef4444}

.link-box{margin-top:8px;font-size:12px;color:#374151;word-break:break-all}

/* ===== å…¨å±å®Œæˆ ===== */
#finish{
  position:fixed;inset:0;
  background:radial-gradient(circle,#fde68a,#fb7185);
  display:none;flex-direction:column;
  justify-content:center;align-items:center;
  z-index:999;color:#fff;text-align:center
}
#finish h2{font-size:28px;margin-bottom:10px}
#finish p{font-size:16px}

/* çº¢åŒ…é›¨ */
.redpack{
  position:absolute;top:-40px;width:26px;height:34px;
  background:#dc2626;border-radius:4px;
  animation:fall 6s linear forwards
}
.redpack::before{
  content:"";position:absolute;top:0;left:0;right:0;height:6px;
  background:#fde68a;border-radius:4px 4px 0 0
}
@keyframes fall{to{transform:translateY(120vh);opacity:0}}
</style>
</head>

<body>

<div class="card">
  <h1>è”ä¿¡èµ„ Â· åŠ©åŠ›è½¬ç›˜</h1>
  <div class="prize-box">å¥–å“ï¼š<span id="prizeText">æœªç¡®å®š</span></div>

  <div class="wheel-wrap">
    <canvas id="wheel" width="600" height="600"></canvas>
    <img id="centerLogo" src="logo.png">
  </div>

  <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>
  <div class="progress-text" id="progressText">å®Œæˆè¿›åº¦ 0%</div>

  <button class="btn secondary" id="btnHelp">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
  <button class="btn primary" id="btnCreate">å‘èµ·åŠ©åŠ›è¯•è¯•</button>

  <div class="link-box" id="linkBox"></div>
</div>

<!-- å®Œæˆ -->
<div id="finish">
  <h2>ğŸ‰ æ­å–œå®ŒæˆåŠ©åŠ› ğŸ‰</h2>
  <p>å¥–åŠ±å·²è¾¾æˆï¼Œè¯·è”ç³»å®¢æœé¢†å–</p>
</div>

<script>
/* ========= Firebase åˆå§‹åŒ–ï¼ˆæ¢æˆä½ è‡ªå·±çš„ï¼‰ ========= */
firebase.initializeApp({
  apiKey: "ä½ çš„ apiKey",
  authDomain: "xxx.firebaseapp.com",
  projectId: "ä½ çš„ projectId"
});
const db = firebase.firestore();

/* ========= åç«¯ ========= */
const CREATE_API="https://createactivity-23p22ouguq-uc.a.run.app/createActivity";
const HELP_API="https://createactivity-23p22ouguq-uc.a.run.app/helpActivity";
const ORIGIN=location.origin;

/* ========= è®¾å¤‡ ========= */
let deviceId=localStorage.getItem("device_id");
if(!deviceId){deviceId=crypto.randomUUID();localStorage.setItem("device_id",deviceId)}

/* ========= è½¬ç›˜ ========= */
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const R=300;
const PRIZES=[
  {key:"66",label:"66å…ƒ"},{key:"88",label:"88å…ƒ"},
  {key:"388",label:"388å…ƒ"},{key:"588",label:"588å…ƒ"},
  {key:"888",label:"888å…ƒ"},{key:"1888",label:"1888å…ƒ"},
  {key:"iphone",label:"iPhone"}
];
const STEP=2*Math.PI/PRIZES.length;
PRIZES.forEach((p,i)=>{
  ctx.beginPath();ctx.moveTo(R,R);
  ctx.arc(R,R,R,i*STEP,(i+1)*STEP);
  ctx.fillStyle=`hsl(${i*40},80%,70%)`;ctx.fill();
  ctx.save();ctx.translate(R,R);ctx.rotate(i*STEP+STEP/2);
  ctx.textAlign="right";ctx.font="bold 24px PingFang SC";
  ctx.fillStyle="#7c2d12";ctx.fillText(p.label,R-30,10);ctx.restore();
});
let angle=0;
function spinTo(i){angle+=1440+i*(360/PRIZES.length);canvas.style.transform=`rotate(${angle}deg)`}

/* ========= å®æ—¶ç›‘å¬ ========= */
function watch(activityId){
  db.collection("activities").doc(activityId).onSnapshot(s=>{
    if(!s.exists)return;
    const d=s.data();
    document.getElementById("progressInner").style.width=d.progress+"%";
    document.getElementById("progressText").innerText="å®Œæˆè¿›åº¦ "+d.progress.toFixed(1)+"%";
    if(d.prizeKey){
      const p=PRIZES.find(x=>x.key===d.prizeKey);
      if(p)document.getElementById("prizeText").innerText=p.label;
    }
    if(d.finished)finish();
  });
}

/* ========= å®Œæˆæ•ˆæœ ========= */
function finish(){
  document.getElementById("finish").style.display="flex";
  document.getElementById("btnHelp").disabled=true;
  document.getElementById("btnCreate").disabled=true;
  for(let i=0;i<80;i++){
    const p=document.createElement("div");
    p.className="redpack";
    p.style.left=Math.random()*100+"%";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),7000);
  }
}

/* ========= å‘èµ· ========= */
document.getElementById("btnCreate").onclick=async()=>{
  const r=await fetch(CREATE_API,{method:"POST",headers:{
    "Content-Type":"application/json","X-Device-Id":deviceId}});
  const d=await r.json();
  const idx=PRIZES.findIndex(p=>p.key===d.prizeKey);
  if(idx>=0)spinTo(idx);
  document.getElementById("linkBox").innerText="åˆ†äº«é“¾æ¥ï¼š"+`${ORIGIN}/?from=${d.activityId}`;
  watch(d.activityId);
};

/* ========= åŠ©åŠ› ========= */
document.getElementById("btnHelp").onclick=async()=>{
  const id=new URLSearchParams(location.search).get("from");
  if(!id)return alert("è¯·é€šè¿‡å¥½å‹åˆ†äº«é“¾æ¥è¿›å…¥");
  const r=await fetch(HELP_API,{method:"POST",headers:{
    "Content-Type":"application/json","X-Device-Id":deviceId},
    body:JSON.stringify({activityId:id})});
  const d=await r.json();
  if(!d.success)alert(d.error||"å·²åŠ©åŠ›");
};
</script>

</body>
</html>


