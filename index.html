<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>è”ä¿¡èµ„åŠ©åŠ›æŠ½å¥–</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* â€”â€” æ ·å¼ä¸ä½ ä¸Šä¸€ç‰ˆå®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œçœç•¥ï¼Œä¸ºé¿å…è¯¯æ”¹ â€”â€” */
</style>
</head>

<body>
<div class="page">
  <div class="container">

    <div class="brand">
      <img src="/logo.png">
      <div class="brand-title">è” ä¿¡ èµ„</div>
      <div class="brand-subtitle">åŠ©åŠ›æŠ½å¥–</div>
    </div>

    <div class="card">
      <div class="hero">
        <div class="circle" id="circle">
          <div class="progress-title">å®Œæˆè¿›åº¦</div>
          <div class="progress-wrap">
            <div class="progress-inner" id="progressInner"></div>
          </div>
          <div class="progress-text" id="progressText">0%</div>
        </div>
      </div>

      <button id="btnHelp" class="secondary">å¸®åŠ©å¥½å‹åŠ©åŠ›</button>
      <button id="btnCreate" class="primary">å‘èµ·åŠ©åŠ›è¯•è¯•</button>

      <div class="link" id="shareLink"></div>
    </div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA_GeAMtgqYBLG9z_EX529fVzmGYZbZl0Y",
  projectId:"cut-demo-e11b9"
});
const db = firebase.firestore();

const CREATE_API="https://createactivity-23p22ouguq-uc.a.run.app";
const HELP_API="https://helpactivity-23p22ouguq-uc.a.run.app";

/* å¥–å“å›¾ */
const PRIZE_IMG={
  "1888":"/1888.png","588":"/588.png","888":"/888.png",
  "66":"/hongbao.png","88":"/hongbao.png","388":"/hongbao.png",
  "iphone":"/iphone.png","shouji":"/shouji.png",
  "rice":"/dami.png","oil":"/you.png"
};
const CAROUSEL=["1888","588","888","66","88","388","rice","oil","shouji","iphone"];

function genUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
let deviceId = localStorage.deviceId || (localStorage.deviceId = genUUID());

const circle=document.getElementById("circle");
const progressInner=document.getElementById("progressInner");
const progressText=document.getElementById("progressText");
const btnCreate=document.getElementById("btnCreate");
const btnHelp=document.getElementById("btnHelp");
const shareLink=document.getElementById("shareLink");

let timer=null;

/* å›¾ç‰‡è½®æ’­ */
function playCarousel(finalKey){
  let index=0,rounds=0;
  const maxRounds=3, interval=1100;

  circle.querySelectorAll(".prize-item,.prize-final").forEach(el=>el.remove());
  clearInterval(timer);

  timer=setInterval(()=>{
    const img=document.createElement("img");
    img.src=PRIZE_IMG[CAROUSEL[index]];
    img.className="prize-item";
    circle.appendChild(img);
    setTimeout(()=>img.remove(),3000);

    index++;
    if(index>=CAROUSEL.length){ index=0; rounds++; }

    if(rounds>=maxRounds){
      clearInterval(timer);
      setTimeout(()=>{
        const finalImg=document.createElement("img");
        finalImg.src=PRIZE_IMG[finalKey];
        finalImg.className="prize-final";
        circle.appendChild(finalImg);
      },1400);
    }
  },interval);
}

/* ç›‘å¬è¿›åº¦ */
function watch(activityId){
  db.collection("activities").doc(activityId).onSnapshot(snap=>{
    if(!snap.exists)return;
    const p=snap.data().progress||0;
    progressInner.style.width=p+"%";
    progressText.innerText=p.toFixed(1)+"%";
  });
}

/* âœ… é¡µé¢åŠ è½½ï¼šä¸å†ç¦ç”¨æŒ‰é’® */
window.onload = () => {
  const params=new URLSearchParams(location.search);
  const from=params.get("from");

  if(!from){
    btnHelp.disabled=true;
    btnHelp.innerText="è¯·åˆ†äº«é“¾æ¥ç»™å¥½å‹åŠ©åŠ›";
  }else{
    watch(from);
  }
};

/* å‘èµ·åŠ©åŠ› */
btnCreate.onclick = async ()=>{
  btnCreate.disabled=true;

  const r = await fetch(CREATE_API,{
    method:"POST",
    headers:{ "x-device-id":deviceId }
  });
  const d = await r.json();
  if(!d.success){
    btnCreate.disabled=false;
    return;
  }

  playCarousel(d.prizeKey);
  watch(d.activityId);
  btnCreate.innerText="å·²å‘èµ·åŠ©åŠ›";
  shareLink.innerText =
    location.origin + location.pathname + "?from=" + d.activityId;
};

/* å¸®åŠ©å¥½å‹ */
btnHelp.onclick = async ()=>{
  const params=new URLSearchParams(location.search);
  const from=params.get("from");
  if(!from)return;

  const r=await fetch(HELP_API,{
    method:"POST",
    headers:{ "x-device-id":deviceId },
    body:JSON.stringify({activityId:from})
  });
  const d=await r.json();

  if(!d.success){
    alert(d.error||"å·²åŠ©åŠ›");
    btnHelp.disabled=true;
    return;
  }

  btnHelp.disabled=true;
  btnHelp.innerText="å·²æˆåŠŸåŠ©åŠ› ğŸ‰";
};
</script>

</body>
</html>






